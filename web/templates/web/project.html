{% extends 'web/base.html' %}
{% block content %}

{% if project %}
<h1>–ü—Ä–æ–µ–∫—Ç "{{ project.title }}"</h1>

<div class="task-info">
    <p><strong>–î–µ–¥–ª–∞–π–Ω:</strong> {{ project.deadline }}</p>
    <p><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> {{ project.manager }}</p>

    <p><strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:</strong></p>

    <div class="employees-list">
        {% for emp in project.employees.all %}
        <div class="employee-card">
            {% if emp.image %}
            <img src="{{ emp.image.url }}" alt="–ê–≤–∞—Ç–∞—Ä {{ emp.fio }}" class="employee-avatar">
            {% else %}
            <img src="/media/img/account_avatars/default_avatar.jpg" alt="–ê–≤–∞—Ç–∞—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" class="employee-avatar">
            {% endif %}
            <div class="employee-details">
                <p><strong>–§–ò–û:</strong> {{ emp.fio }}</p>
                <p><strong>Email:</strong> {{ emp.email }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="dashboard">
    <div class="dashboard-section">
        <div class="section-title-with-button"
             style="display: flex; justify-content: space-between; align-items: center;">
            <div class="section-title">–ó–∞–¥–∞—á–∏</div>
            {% if is_manager %}
            <button onclick="addColumn()" class="add-column-btn">+ –ö–æ–ª–æ–Ω–∫–∞</button>
            {% endif %}
        </div>

        <div class="columns-container" style="display:flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">
            {% for column, tasks in columns_with_tasks %}
            <div class="column-card">
                <div class="column-header">
                    <span class="column-title" id="title-{{ column.id }}">{{ column.name }}</span>
                    {% if is_manager %}
                    <div class="column-actions">
                        <button class="rename-btn" onclick="toggleRename({{ column.id }})">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteColumn({{ column.id }})">üóë</button>
                    </div>
                    {% endif %}
                </div>
                {% if is_manager %}
                <input type="text"
                       id="input-{{ column.id }}"
                       class="rename-input"
                       value="{{ column.name }}"
                       onblur="applyRename({{ column.id }})">
                {% endif %}
                <div class="card-list" data-column-id="{{ column.id }}">
                    {% for task in tasks %}
                    <div class="card task {% if task.is_done %}done{% endif %}"
                         draggable="{{ is_manager|yesno:'true,false' }}"
                         data-task-id="{{ task.id }}">
                        <div class="card-title">{{ task.title }}</div>
                        <div class="card-info">
                            <span class="icon">üìÖ</span>{{ task.date_added|date:"d/m/Y" }}
                            <span class="icon">‚è∞</span>{{ task.deadline|date:"d/m/Y" }}
                            <span class="icon">üë•</span>
                            {% for employee in task.employees.all %}
                            {{ employee.fio }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% if project.is_done == False %}
{% if project.manager == user %}
<a href="{% url 'edit_project' project.id %}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
<a href="{% url 'delete_project' project.id %}">–£–¥–∞–ª–∏—Ç—å</a> |
{% endif %}
<a href="{% url 'complete_project' project.id %}">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</a>
{% else %}
<a href="{% url 'complete_project' project.id %}">–û—Ç–º–µ–Ω–∏—Ç—å</a>
{% endif %}

{% else %}
<h1>–ü—Ä–æ–µ–∫—Ç—ã</h1>
<b>–ü—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç :)</b><br>
{% endif %}

{% if is_manager %}
<script>
    // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á
    document.querySelectorAll('.card.task').forEach(card => {
        card.addEventListener('dragstart', e => {
            e.dataTransfer.setData('taskId', card.dataset.taskId);
        });

        // –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ –∫–ª–∏–∫—É
        card.addEventListener('click', () => {
            const taskId = card.dataset.taskId;
            window.location.href = `/task/${taskId}/`; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π URL, –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π
        });
    });

    document.querySelectorAll('.card-list').forEach(list => {
        list.addEventListener('dragover', e => e.preventDefault());

        list.addEventListener('drop', e => {
            e.preventDefault();
            const taskId = e.dataTransfer.getData('taskId');
            const columnId = list.dataset.columnId;

            fetch("{% url 'move_task' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({task_id: taskId, column_id: columnId})
            }).then(res => {
                if (res.ok) location.reload();
            });
        });
    });

    // ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É
    function addColumn() {
        fetch("{% url 'add_column' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ project_id: {{ project.id }} })
        }).then(res => {
            if (res.ok) location.reload();
        });
    }

    // ‚úÖ –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
    function toggleRename(columnId) {
        const input = document.getElementById(`input-${columnId}`);
        const title = document.getElementById(`title-${columnId}`);
        if (input.style.display === 'block') {
            input.style.display = 'none';
            title.style.display = 'block';
        } else {
            input.style.display = 'block';
            input.focus();
            title.style.display = 'none';
        }
    }

    // ‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É
    function applyRename(columnId) {
        const input = document.getElementById(`input-${columnId}`);
        const newName = input.value;

        fetch("{% url 'rename_column' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ column_id: columnId, name: newName })
        }).then(() => location.reload());
    }

    // ‚úÖ –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É
    function deleteColumn(columnId) {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É?")) return;

        fetch("{% url 'delete_column' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ column_id: columnId })
        }).then(res => {
            if (res.ok) location.reload();
            else alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É, –ø–æ–∫–∞ –≤ –Ω–µ–π –µ—Å—Ç—å –∑–∞–¥–∞—á–∏.");
        });
    }
    document.querySelectorAll('.card.task').forEach(card => {
    card.addEventListener('dragstart', e => {
        e.dataTransfer.setData('taskId', card.dataset.taskId);
        e.dataTransfer.effectAllowed = 'move';
    });
});

document.querySelectorAll('.card-list').forEach(list => {
    list.addEventListener('dragover', e => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    });

    list.addEventListener('dragenter', () => {
        list.classList.add('drag-over');
    });

    list.addEventListener('dragleave', () => {
        list.classList.remove('drag-over');
    });

    list.addEventListener('drop', e => {
        e.preventDefault();
        list.classList.remove('drag-over');

        const taskId = e.dataTransfer.getData('taskId');
        const columnId = list.dataset.columnId;

        fetch("{% url 'move_task' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ task_id: taskId, column_id: columnId })
        }).then(res => {
            if (res.ok) {
                location.reload();
            } else {
                res.json().then(data => {
                    alert(data.error || "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è");
                });
            }
        });
    });
});
</script>

{% endif %}
{% endblock %}